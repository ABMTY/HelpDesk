
@{
    ViewBag.Title = "Index";
}

<!--Contenido-->
<div class="row">
    <div class="col-md-12">
        <div class="box">
            <!--header -->
            <div class="box-header with-border">
                <h1 class="box-title">
                    Usuarios                   
                </h1>
                <div class="box-tools pull-right">
                    <button class="btn btn-primary" onclick="Agregar()" id="btnAgregar">
                        <i class="fa fa-plus-circle"></i> Agregar
                    </button>
                </div>
            </div>
            <!-- Fin header -->
            <!-- body -->
            <div class="panel-body table-responsive" id="secc_lista">
                <div class="card-box">
                    <table id="Lista_Usuarios" class="table table-striped table-bordered dt-responsive nowrap" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Opciones</th>
                                <th>Nombre</th>
                                <th>Usuario</th>
                                <th>Tipo Usuario</th>
                                <th>Foto</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>

            <div class="panel-body" id="secc_add" style="display:none;">
                <input type="text" id="id" value="" hidden />
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Usuario *</label>
                    <input type="text" class="form-control" id="txt_Usuario" maxlength="100" required>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Contraseña *</label>
                    <input type="text" class="form-control" id="txt_Contraseña" maxlength="100" required>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Nombre *</label>
                    <input type="text" class="form-control" id="txt_Nombre" maxlength="100" required>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Apellidos *</label>
                    <input type="text" class="form-control" id="txt_Apellidos" maxlength="100" required>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Correo *</label>
                    <input type="text" class="form-control" id="txt_Correo" maxlength="100" required>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Teléfono *</label>
                    <input type="text" class="form-control" id="txt_Telefono" maxlength="100" required>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Extension *</label>
                    <input type="text" class="form-control" id="txt_Extension" maxlength="100" required>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Tipo usuario *</label>
                    <div>
                        <select class="form-control selectpicker" id="ddl_TipoUsuario" required data-live-search="true"></select>
                    </div>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Area *</label>
                    <div>
                        <select class="form-control selectpicker" id="ddl_Areas" required data-live-search="true"></select>
                    </div>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Sucursal *</label>
                    <div>
                        <select class="form-control selectpicker" id="ddl_Sucursales" required data-live-search="true"></select>
                    </div>
                </div>
                <div class="form-group col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <label>Foto</label>
                    <input type="file" id="subirImagen" onchange="ConvertirImagen()" value=""  />
                    <p id="imgBase64" style="display: none;"></p>
                    <img src="" alt="" id="imagen" width="30%;" height="30%;" /><br />
                    <img src="" alt="" id="imagenOriginal" width="30%;" height="30%;" />
                </div>
                <div class="form-group col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <button class="btn btn-primary" type="submit" id="btnGuardar" onclick="Guardar()">
                        <i class="fa fa-save"></i> Guardar
                    </button>
                    <button class="btn btn-default" onclick="Cancelar()" type="button">
                        <i class="fa fa-arrow-circle-left"></i> Cancelar
                    </button>
                </div>
            </div>
            <!--Fin body -->
        </div><!-- /.box -->
        <!-- Modal Eliminar -->
        <div class="modal fade" id="Form_DeleteTipo" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title" id="mensaje_modal">Eliminar Usuario</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body ">
                        <form role="form" data-toggle="validator">
                            <h4 id="lbl_msjborrar"></h4>
                            <span id="txt_idborrar" style="display:none;"></span>
                        </form>

                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="Eliminar(); return false;"><i class="fa fa-check" aria-hidden="true"></i> SÍ</button>
                        <button class="btn btn-danger" onclick="Cancelar()" ; return false;" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i> NO</button>
                    </div>
                </div>
            </div>
        </div>       
    </div><!-- /.col -->
</div><!-- /.row -->
<!--Fin-Contenido-->

<script>

    $(document).ready(function () {
        $('#Lista_Usuarios').DataTable();
        Cargar_Usuarios();
    });

    function Cargar_Usuarios() {
        $('#Lista_Usuarios').DataTable({
            destroy: true,
            searching: true,
            "ajax": {
                "url": "/Usuarios/GetUsuarios/",
                "type": "GET"
            },
            "columns": [
                { "defaultContent": "<i>..</i>" },
                { "data": "nombre_completo" },
                { "data": "user_name" },                
                { "data": "tipo_usuario" },
                { "defaultContent": "" },
            ],
            "columnDefs": [
                {
                    "targets": 0, "data": "id_usuario", "render": function (data, type, full, meta) {
                        return "<button type='button' title='Editar' id='btn_mas" + data + "' class='btn btn-warning' onclick='Editar(" + data + ")'  ><i class='fa fa-edit'></i></button>  <button type='button' title='Eliminar' id='btn_borrar" + data + "' class='btn btn-danger' onclick='Confirma_Eliminar(" + data + ")'><i class='fa fa-trash'></i></button> "
                    }
                },
                {
                    "targets": 4, "data": "foto", "render": function (data, type, full, meta) {
                        if (data != null) {
                            var url = "data:image/png;base64,"+data;
                            return "<img src=" + url + " width='60px;' height='50px;' />"
                        } else {
                            return "<p></p>"
                        }

                    }
                }
            ]
        });
    }

    function Agregar() {
        $("#secc_lista").hide();
        $("#secc_add").show();
        $("#btnAgregar").hide();
        Limpiar();        
        Cargar_TipoUsuario();
        Cargar_Areas();
        Cargar_Sucursales();
    }

    function Cancelar() {
        $("#secc_lista").show();
        $("#btnAgregar").show();
        $("#secc_add").hide();
    }

    function Limpiar() {
        $("#id").val("");
        $("#txt_Usuario").val("");
        $("#txt_Contraseña").val("");
        $("#txt_Nombre").val("");
        $("#txt_Apellidos").val("");
        $("#txt_Correo").val("");
        $("#txt_Telefono").val("");
        $("#txt_Extension").val("");
        $("#ddl_TipoUsuario").html();
        $("#ddl_Areas").html();
        $("#ddl_Sucursales").html();
        $('#imagen').attr('src', '');
    }

    function Cargar_TipoUsuario() {

        $("#ddl_TipoUsuario").html("");

        $.ajax({
            url: "/TipoUsuario/GetTipoUsuarios/",
            async: true,
            dataType: "json",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $.each(data.data, function (i, Item) {
                    $("#ddl_TipoUsuario").append("<option value='" + Item.id_tipo_usuario + "'>" + Item.nombre + "</option>");
                });
                $('#ddl_TipoUsuario').selectpicker('refresh');
            },
            error: function (request, status, error) {
                console.log("error" + error);
            }
        });
    }
    function Cargar_Areas() {

        $("#ddl_Areas").html("");

        $.ajax({
            url: "/Areas/GetAreas/",
            async: true,
            dataType: "json",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $.each(data.data, function (i, Item) {
                    $("#ddl_Areas").append("<option value='" + Item.id_area + "'>" + Item.nombre + "</option>");
                });
                $('#ddl_Areas').selectpicker('refresh');
            },
            error: function (request, status, error) {
                console.log("error" + error);
            }
        });
    }
    function Cargar_Sucursales() {

        $("#ddl_Sucursales").html("");

        $.ajax({
            url: "/Sucursales/GetSucursales/",
            async: true,
            dataType: "json",
            type: "POST",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $.each(data.data, function (i, Item) {
                    $("#ddl_Sucursales").append("<option value='" + Item.id_sucursal + "'>" + Item.nombre + "</option>");
                });
                $('#ddl_Sucursales').selectpicker('refresh');
            },
            error: function (request, status, error) {
                console.log("error" + error);
            }
        });
    }

    function Editar(id_usuario) {
        $.ajax({
            url: "/Usuarios/GetUsuario/",
            async: true,
            dataType: "json",
            data: '{ id:' + id_usuario + '}',
            type: "POST",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                Limpiar();
                $("#secc_lista").hide();
                $("#secc_add").show();
                $("#btnAgregar").hide();
                $("#id").val(id_usuario);                
                $("#txt_Usuario").val(data.data.user_name);
                $("#txt_Contraseña").val(data.data.password);
                $("#txt_Nombre").val(data.data.nombre);
                $("#txt_Apellidos").val(data.data.apellidos);
                $("#txt_Correo").val(data.data.correo);
                $("#txt_Telefono").val(data.data.telefono);
                $("#txt_Extension").val(data.data.ext);                
                Cargar_TipoUsuario();               
                $("#ddl_TipoUsuario").append("<option value=" + data.data.id_tipo_usuario + ">" + data.data.tipo_usuario + "</option>");
                $("#ddl_TipoUsuario").selectpicker('refresh');
                Cargar_Areas();
                $("#ddl_Areas").append("<option value=" + data.data.id_area + ">" + data.data.area + "</option>");
                $("#ddl_Areas").selectpicker('refresh');
                Cargar_Sucursales();
                $("#ddl_Sucursales").append("<option value=" + data.data.id_sucursal + ">" + data.data.sucursal + "</option>");
                $("#ddl_Sucursales").selectpicker('refresh');
                $("#imgBase64").text(data.data.foto)
                if (data.data.foto != "") {
                    $('#imagen').css({ 'width': '0%', 'height': '0%' });
                    $('#imagenOriginal').attr('src', 'data:image/png;base64,' + data.data.foto);
                }
            },
            error: function (request, status, error) {
                console.log("error" + error);
            }
        });
    }

    function Guardar() {      
        Usuario = {
            "id_usuario": $("#id").val() == "" ? 0 : $("#id").val(),
            "user_name": $("#txt_Usuario").val(),
            "password": $("#txt_Contraseña").val(),
            "nombre": $("#txt_Nombre").val(),
            "apellidos": $("#txt_Apellidos").val(),
            "correo": $("#txt_Correo").val(),
            "telefono": $("#txt_Telefono").val(),
            "ext": $("#txt_Extension").val(),            
            "id_tipo_usuario": $("#ddl_TipoUsuario").val(),            
            "id_area": $("#ddl_Areas").val(),
            "id_sucursal": $("#ddl_Sucursales").val(),
            "foto": $("#imgBase64").text(),
        };
        $.ajax(
        {
            url: "/Usuarios/Guardar/",
            async: true,
            dataType: "json",
            data: JSON.stringify(Usuario),
            type: "POST",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                swal({ title: "Usuarios", text: "Guardada Correctamente", type: "success" }, function () { Cargar_Usuarios(); Cancelar(); });
            },
            error: function (request, status, error) {
                swal("Error al Guardar la Usuario");
                console.log("error" + error);
            }
        });
    }

    function ConvertirImagen() {
        var archivoImagen = document.getElementById("subirImagen").files;
        if (archivoImagen.length > 0) {
            var archivoCargar = archivoImagen[0];
            var archivoLeer = new FileReader();

            archivoLeer.onload = function (eventoCargarArchivo) {
                var srcData = eventoCargarArchivo.target.result; //Imagen base64
                //alert(srcData);
                var Logo = srcData.split(',')[1];
                //alert(Logo)
                document.getElementById("imagen").src = srcData;
                document.getElementById("imgBase64").textContent = Logo;

            }
            archivoLeer.readAsDataURL(archivoCargar);
        }
    }

    function Confirma_Eliminar(id_usuario) {
        $('#Form_DeleteTipo').modal('show');
        $("#lbl_msjborrar").html("Se va a eliminar el Usuario No. " + id_usuario + ". <br/>¿Desea Continuar?");
        $("#txt_idborrar").text(id_usuario);
    }

    function Eliminar() {
        id_usuario = $("#txt_idborrar").text();
        $.ajax({
            url: "/Usuarios/Eliminar/",
            async: true,
            dataType: "json",
            data: '{id:' + id_usuario + '}',
            type: "POST",
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                $('#Form_DeleteTipo').modal('hide');
                swal({ title: "Usuarios", text: "Se elimino Correctamente", type: "success" }, function () { Cargar_Usuarios(); });
            },
            error: function (request, status, error) {
                console.log("error" + error);
            }
        });
    }

</script>




